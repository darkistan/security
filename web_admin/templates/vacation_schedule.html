{% extends "base.html" %}
{% block title %}Графік відпусток - {{ month_name }} {{ year }} - Security{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h1 class="mb-2"><i class="bi bi-calendar-check"></i> Графік відпусток</h1>
        <p class="text-muted mb-0">Клік по клітинці — додати або прибрати відпустку в цей день. Блакитна клітинка — день відпустки.</p>
    </div>
</div>

<!-- Навігація по місяцях та фільтр об'єкта -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="btn-group" role="group">
            <a href="{{ url_for('vacation_schedule_page', year=year if month > 1 else year - 1, month=month - 1 if month > 1 else 12, object_id=selected_object_id) }}" class="btn btn-outline-primary">
                <i class="bi bi-chevron-left"></i> Попередній місяць
            </a>
            <span class="btn btn-primary disabled">{{ month_name }} {{ year }}</span>
            <a href="{{ url_for('vacation_schedule_page', year=year if month < 12 else year + 1, month=month + 1 if month < 12 else 1, object_id=selected_object_id) }}" class="btn btn-outline-primary">
                Наступний місяць <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>
    <div class="col-md-6">
        <form method="GET" action="{{ url_for('vacation_schedule_page') }}" class="d-inline">
            <input type="hidden" name="year" value="{{ year }}"/>
            <input type="hidden" name="month" value="{{ month }}"/>
            <label class="me-2">Об'єкт:</label>
            <select name="object_id" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                <option value="">Всі охоронці</option>
                {% for obj in objects_list %}
                <option value="{{ obj.id }}" {% if obj.id == selected_object_id %}selected{% endif %}>{{ obj.name }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<!-- Сітка місяця -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 vacation-grid">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 3rem;">№ з/п</th>
                                <th style="min-width: 12rem;">Прізвище, ім'я по батькові</th>
                                {% for day in range(1, days_in_month + 1) %}
                                <th class="text-center" style="width: 2rem;">{{ day }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for guard in guards %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td>{{ guard.full_name }}</td>
                                {% for day in range(1, days_in_month + 1) %}
                                {% set slot_key = (guard.user_id, day) %}
                                {% set has_slot = slot_key in slots_set %}
                                <td class="text-center p-0 {% if has_slot %}table-info{% endif %}" style="min-width: 2rem;">
                                    {% if current_user.is_admin %}
                                    <form method="POST" action="{{ url_for('vacation_schedule_toggle') }}" class="m-0 d-block">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <input type="hidden" name="guard_id" value="{{ guard.user_id }}"/>
                                        <input type="hidden" name="date" value="{{ '%04d-%02d-%02d' % (year, month, day) }}"/>
                                        <input type="hidden" name="year" value="{{ year }}"/>
                                        <input type="hidden" name="month" value="{{ month }}"/>
                                        {% if selected_object_id %}<input type="hidden" name="object_id" value="{{ selected_object_id }}"/>{% endif %}
                                        <button type="submit" class="btn btn-sm w-100 border-0 {% if has_slot %}bg-info text-dark{% else %}bg-transparent{% endif %}" style="min-height: 2rem;" title="Клік — {{ 'прибрати відпустку' if has_slot else 'додати відпустку' }}">&nbsp;</button>
                                    </form>
                                    {% else %}
                                    <span class="d-block" style="min-height: 2rem;">{% if has_slot %}●{% endif %}</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not guards %}
                <p class="text-muted p-3 mb-0">Немає охоронців для відображення. Оберіть інший об'єкт або додайте охоронців.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
